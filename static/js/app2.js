// Generated by CoffeeScript 1.9.1
(function() {
  var buildAddView, buildTableView, cipher, compress, database, db_url, decipher, decompress, emptyMain, raw_database, req;

  db_url = "static/db.txt";

  raw_database = void 0;

  database = void 0;

  sjcl.random.startCollectors();

  compress = function(message) {
    return Base64.toBase64(RawDeflate.deflate(Base64.utob(message)));
  };

  decompress = function(data) {
    return Base64.btou(RawDeflate.inflate(Base64.fromBase64(data)));
  };

  cipher = function(key, message) {
    return sjcl.encrypt(key, JSON.stringify(message));
  };

  decipher = function(key, data) {
    return JSON.parse(sjcl.decrypt(key, data));
  };

  emptyMain = function() {
    var c, i, len, myNode, ref, results;
    myNode = document.getElementsByTagName("main")[0];
    ref = myNode.children;
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      c = ref[i];
      results.push(myNode.removeChild(c));
    }
    return results;
  };

  buildTableView = function() {
    var e, html, i, len, ref;
    emptyMain();
    html = "<p><a href=\"\" id=\"add-a\">New password</a></p><table><tr><th>Site</th><th>Password</th><th>Edit</th><th>Delete</th></tr>";
    ref = window.database;
    for (i = 0, len = ref.length; i < len; i++) {
      e = ref[i];
      html += "<tr><td>TODO</td><td>" + e.password + "</td><td><a class=\"edit-a\" href=\"\">Edit</a></td><td><a class=\"delete-a\" href=\"\">Delete</a></td></tr>";
    }
    html += "</table>";
    document.getElementsByTagName("main")[0].innerHTML = html;
    return document.getElementById("add-a").addEventListener("click", function(evt) {
      evt.preventDefault();
      return buildAddView();
    });
  };

  buildAddView = function() {
    var html;
    emptyMain();
    html = "<form>";
    html += "</form>";
    return document.getElementsByTagName("main")[0].innerHTML = html;
  };

  req = new XMLHttpRequest();

  req.open('GET', db_url, true);

  req.onreadystatechange = function(aEvt) {
    if (req.readyState = 4) {
      if (req.status = 200) {
        window.raw_database = req.responseText;
        document.getElementById("info-p").innerHTML = "";
        return document.querySelector("#main-pass-form input[type=submit]").removeAttribute("disabled");
      } else {
        console.log("Erreur pendant le chargement de la base de donn√©es.\n");
        return document.getElementById("info-p").innerHTML = "Unable to load the database";
      }
    }
  };

  req.send(null);

  document.getElementById("main-pass-form").addEventListener("submit", function(evt) {
    var err;
    evt.preventDefault();
    if (window.raw_database === void 0) {
      return;
    }
    try {
      window.database = decipher(document.getElementById("main-pass-input").value, window.raw_database);
    } catch (_error) {
      err = _error;
      console.log(err);
      document.getElementById("info-p").innerHTML = "Invalid main password!";
      return;
    }
    return buildTableView();
  });

}).call(this);
