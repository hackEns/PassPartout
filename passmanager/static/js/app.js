// Generated by CoffeeScript 1.9.1
(function() {
  var buildAddView, buildTableView, cipher, compress, database, db_push, db_url, decipher, decompress, emptyMain, get_url, password, random_password, save, send_via_post;

  db_url = "/get/" + keyring;

  db_push = "/save/" + keyring;

  database = void 0;

  sjcl.random.startCollectors();

  compress = function(message) {
    return Base64.toBase64(RawDeflate.deflate(Base64.utob(message)));
  };

  decompress = function(data) {
    return Base64.btou(RawDeflate.inflate(Base64.fromBase64(data)));
  };

  cipher = function(key, message) {
    return sjcl.encrypt(key, JSON.stringify(message));
  };

  decipher = function(key, data) {
    return JSON.parse(sjcl.decrypt(key, data));
  };

  get_url = function(url, feedback, error) {
    var req;
    req = new XMLHttpRequest();
    req.open('GET', url, true);
    req.onreadystatechange = function(aEvt) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          return feedback(req.responseText);
        } else {
          return error();
        }
      }
    };
    return req.send(null);
  };

  random_password = function() {
    return Math.random().toString(36).slice(2, 12) + Math.random().toString(36).slice(2, 12);
  };

  send_via_post = function(url, data, feedback, error) {
    var req;
    req = new XMLHttpRequest();
    req.open('POST', url, true);
    data = "data=" + encodeURIComponent(data);
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    req.setRequestHeader("Content-length", data.length);
    req.setRequestHeader("Connection", "close");
    req.onreadystatechange = function(aEvt) {
      if (req.readyState === 4) {
        if (req.status === 200) {
          return feedback(req.responseText);
        } else {
          return error();
        }
      }
    };
    return req.send(data);
  };

  save = function(cb) {
    var data;
    data = cipher(password, window.database);
    console.log(window.database);
    return send_via_post(db_push, data, function(success) {
      console.log("ok");
      if (cb) {
        return cb();
      }
    }, function() {
      return console.log(":(");
    });
  };

  emptyMain = function() {
    var c, i, len, myNode, ref, results;
    myNode = document.getElementsByTagName("main")[0];
    ref = myNode.children;
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      c = ref[i];
      results.push(myNode.removeChild(c));
    }
    return results;
  };

  buildTableView = function() {
    var e, el, i, input_element, j, k, l, len, len1, len2, main, newpass, ref, ref1, ref2, table;
    main = document.getElementsByTagName("main")[0];
    main.innerHTML = "";
    main.innerHTML += "<p><a href=\"\" id=\"add-a\">New password</a></p><table><tr><th>Site</th><th>Username</th><th>Password</th><th>Edit</th><th>Delete</th></tr> </table>";
    table = document.querySelector("main table");
    ref = window.database;
    for (i = 0, len = ref.length; i < len; i++) {
      e = ref[i];
      l = document.createElement("tr");
      l.innerHTML = "<tr><td><input readonly name='website' type=\"text\" value=\"" + e.website + "\" /></td><td><input readonly name='username' type=\"text\" value=\"" + e.username + "\" /></td><td><input readonly name='password' class='text-hidden' type=\"text\" value=\"" + e.password + "\" /></td><td><button class=\"edit-a\">Edit</button></td><td><button class=\"delete-a\">Delete</button></td></tr>";
      l.edited = false;
      ref1 = l.getElementsByTagName("input");
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        input_element = ref1[j];
        input_element.addEventListener("keypress", (function(l) {
          return function(evt) {
            if (evt.keyCode === 13) {
              return l.getElementsByClassName("edit-a")[0].click();
            }
          };
        })(l));
      }
      l.getElementsByClassName("edit-a")[0].addEventListener("click", (function(l, e) {
        return function(evt) {
          var btn, element, input, k, len2, len3, len4, m, n, ref2, ref3, ref4;
          if (l.edited) {
            ref2 = l.getElementsByTagName("input");
            for (k = 0, len2 = ref2.length; k < len2; k++) {
              element = ref2[k];
              element.setAttribute("readonly", null);
            }
            ref3 = l.getElementsByTagName("input");
            for (m = 0, len3 = ref3.length; m < len3; m++) {
              input = ref3[m];
              if (input.name === "website") {
                e.website = input.value;
              }
              if (input.name === "password") {
                e.password = input.value;
              }
              if (input.name === "username") {
                e.username = input.value;
              }
            }
            btn = this;
            save(function() {
              btn.innerHTML = "Saved";
              return console.log("done");
            });
          } else {
            ref4 = l.getElementsByTagName("input");
            for (n = 0, len4 = ref4.length; n < len4; n++) {
              element = ref4[n];
              element.removeAttribute("readonly");
            }
            this.innerHTML = "Ok";
          }
          return l.edited = !l.edited;
        };
      })(l, e));
      l.getElementsByClassName("delete-a")[0].addEventListener("click", (function(l, e) {
        return function(evt) {
          window.database.splice(window.database.indexOf(e), 1);
          return save(function() {
            return buildTableView();
          });
        };
      })(l, e));
      table.appendChild(l);
    }
    newpass = document.createElement("tr");
    newpass.innerHTML = "<form><td><input name='website' type='text' placeholder='Website' /></td><td><input name='username' type='text' placeholder='Username' /></td><td><input name='password' type='text' value='" + random_password() + "' /></td><td><button class=\"add\">Add</button></td></form>";
    table.appendChild(newpass);
    newpass.getElementsByClassName("add")[0].addEventListener("click", function(evt) {
      var input, k, len2, ref2;
      e = {};
      ref2 = newpass.getElementsByTagName("input");
      for (k = 0, len2 = ref2.length; k < len2; k++) {
        input = ref2[k];
        if (input.name === "website") {
          e.website = input.value;
        }
        if (input.name === "username") {
          e.username = input.value;
        }
        if (input.name === "password") {
          e.password = input.value;
        }
      }
      console.log(window.database);
      window.database.push(e);
      console.log(window.database);
      return save(function() {
        return buildTableView();
      });
    });
    ref2 = table.getElementsByClassName('text-hidden');
    for (k = 0, len2 = ref2.length; k < len2; k++) {
      el = ref2[k];
      el.addEventListener('click', function(evt) {
        return this.select();
      });
      el.addEventListener('dbclick', function(evt) {
        return this.select();
      });
    }
    return document.getElementById("add-a").addEventListener("click", function(evt) {
      evt.preventDefault();
      return buildAddView();
    });
  };

  buildAddView = function() {
    var html;
    emptyMain();
    html = "<form>";
    html += "</form>";
    return document.getElementsByTagName("main")[0].innerHTML = html;
  };

  password = null;

  document.getElementById("main-pass-form").addEventListener("submit", function(evt) {
    evt.preventDefault();
    return get_url(db_url, function(data) {
      var err;
      try {
        console.log(window.database);
        window.database = decipher(document.getElementById("main-pass-input").value, data);
        password = document.getElementById("main-pass-input").value;
        return buildTableView();
      } catch (_error) {
        err = _error;
        console.log(err);
        return document.getElementById("info-p").innerHTML = "Invalid main password!";
      }
    }, function() {
      console.log("Erreur pendant le chargement de la base de donn√©es.\n");
      return document.getElementById("info-p").innerHTML = "Unable to load the database";
    });
  });

}).call(this);
